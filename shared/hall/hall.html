<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Схема залу — каса</title>

  <link rel="stylesheet" href="../styles.css" />

  <!-- QR генерация в браузере -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.4/build/qrcode.min.js"></script>

  <style>
    .hall-layout{display:flex;gap:24px;align-items:flex-start;}
    .hall-left{flex:1 1 auto;min-width:0;}
    .hall-sidebar{width:360px;flex:0 0 360px;}
    .hall-card{margin-top:0;}

    .hall-scroll{
      background:#e5e7eb;border-radius:16px;padding:12px;
      overflow-x:auto;overflow-y:visible;-webkit-overflow-scrolling:touch;
    }
    .hall-inner{width:max(980px,100%);}

    .hall-section{margin-bottom:18px;}
    .hall-section-title{
      text-align:center;font-size:14px;text-transform:uppercase;
      letter-spacing:.08em;color:#6b7280;margin:4px 0 6px;
    }

    .row-line{display:flex;align-items:center;gap:8px;margin-bottom:4px;}
    .row-label{width:22px;text-align:right;font-size:11px;color:#6b7280;flex:0 0 22px;}
    .seats-row{display:flex;gap:4px;flex-wrap:nowrap;}

    .seat{
      width:24px;height:24px;border-radius:6px;border:1px solid #d1d5db;background:#fff;
      font-size:11px;display:flex;align-items:center;justify-content:center;
      cursor:pointer;padding:0;user-select:none;
    }
   .seat--200 { background:#0ea5e9; color:#fff; }
.seat--180 { background:#a3a300; color:#111; }
.seat--170 { background:#155e75; color:#fff; }
.seat--160 { background:#facc15; color:#111; }
.seat--140 { background:#84cc16; color:#111; }
.seat--120 { background:#38bdf8; color:#111; }
.seat--100 { background:#c2410c; color:#fff; }
.seat--70  { background:#0f766e; color:#fff; }

.seat--no-sale {
  background:#e5e7eb !important;
  color:#9ca3af !important;
  cursor:not-allowed;
}



    .seat--selected{background:#2563eb !important;color:#fff;border-color:#2563eb;}

    .seat--sold{background:#9ca3af !important;color:#fff;border-color:#9ca3af;cursor:not-allowed;}
    .seat--reserved{background:#f59e0b !important;color:#111827;border-color:#f59e0b;}
    .seat--blocked{background:#111827 !important;color:#fff;border-color:#111827;cursor:not-allowed;}

    .seat--gap-right{margin-right:16px;}
    .amphi-gap{width:24px;flex:0 0 24px;}

    .parter-wrap{display:flex;justify-content:center;align-items:flex-start;gap:24px;}
    .hall-lodge{display:flex;flex-direction:column;align-items:center;gap:4px;}
    .hall-lodge-label{font-size:11px;color:#6b7280;margin-bottom:4px;}
    .hall-lodge-seats{display:flex;flex-direction:column;gap:4px;}

    .hall-summary-title{margin-top:0;margin-bottom:8px;}
    .hall-summary-meta{font-size:14px;color:#4b5563;margin:4px 0;}

    .row-price-list{
      margin-top:14px;padding:12px 14px;background:#f7f7f8;border-radius:12px;font-size:14px;
    }
    .row-price{
      display:flex;align-items:center;gap:8px;font-size:14px;color:#0f172a;
      padding:6px 0;border-bottom:1px dotted #e5e7eb;
    }
    .row-price:last-child{border-bottom:0;}
    .row-price .dots{flex:1 1 auto;border-bottom:1px dotted #e5e7eb;height:0;transform:translateY(-2px);}

    .seat--empty{visibility:hidden;pointer-events:none;border:none;background:transparent;}

    .cash-badge{
      display:flex;flex-wrap:wrap;align-items:center;gap:8px;
      background:#f1f5f9;border:1px solid #e2e8f0;color:#0f172a;
      padding:8px 12px;border-radius:14px;font-size:12px;margin:6px 0 14px;
    }
    .pill{
      display:inline-flex;align-items:center;gap:6px;
      padding:2px 10px;border-radius:999px;background:#e2e8f0;color:#0f172a;font-size:11px;
      border:1px solid rgba(15,23,42,.08);
    }
    .pill.ok{background:#bbf7d0;}
    .pill.warn{background:#fed7aa;}
    .pill.bad{background:#fecaca;}
    .pill.dark{background:#111827;color:#fff;}

    .cash-actions{display:flex;flex-direction:column;gap:10px;margin-top:10px;}
    .btn{border:0;border-radius:12px;padding:12px 14px;font-weight:800;cursor:pointer;}
    .btn:disabled{opacity:.45;cursor:not-allowed;}
    .btn-sell{background:#fca5a5;color:#111827;}
    .btn-reserve{background:#fed7aa;color:#111827;}
    .btn-clear{background:#e5e7eb;color:#111827;}
    .btn-sync{background:#bbf7d0;color:#111827;}
    .btn-reset{background:#111827;color:#fff;margin-top:6px;}
    .btn-ghost{background:#f1f5f9;color:#0f172a;border:1px solid #e2e8f0;}

    .note{
      font-size:12px;color:#6b7280;line-height:1.35;margin-top:10px;
      background:#f8fafc;border:1px solid #e2e8f0;border-radius:12px;padding:10px 12px;
    }

    .smallline{font-size:12px;color:#6b7280;margin-top:8px;line-height:1.35;}
    .k-sep{height:1px;background:#e5e7eb;margin:12px 0;}
    .k-mini{font-size:12px;color:#6b7280;}
    .k-h3{margin:8px 0 6px;font-size:14px;}
    .k-table{width:100%;border-collapse:collapse;font-size:12px;}
    .k-table th,.k-table td{padding:6px 6px;border-bottom:1px solid #eef2f7;vertical-align:top;}
    .k-table th{text-align:left;color:#6b7280;font-weight:700;}
    .k-table td{color:#0f172a;}
    .k-table .muted{color:#6b7280;}

    /* Modal */
    .modalBack{position:fixed;inset:0;background:rgba(15,23,42,.55);display:none;align-items:center;justify-content:center;padding:16px;z-index:50;}
    .modal{width:min(560px,100%);background:#fff;border-radius:16px;padding:14px;border:1px solid #e5e7eb;box-shadow:0 20px 60px rgba(15,23,42,.25);}
    .modal h2{margin:0 0 10px;}
    .formRow{display:grid;gap:6px;margin:10px 0;}
    .formRow label{font-size:12px;color:#6b7280;}
    .formRow input{border:1px solid #e5e7eb;border-radius:12px;padding:10px 12px;font-size:14px;}
    .modalActions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px;flex-wrap:wrap;}

    @media (max-width:900px){
      .hall-layout{flex-direction:column;}
      .hall-sidebar{width:auto;}
    }

    /* -------------------- EMBED MODE (backoffice) -------------------- */
    html.embed .hall-sidebar { display: none !important; }
    html.embed .cash-badge { display: none !important; }
    html.embed .row-price-list { display: none !important; }

    html.embed .container { max-width: 100% !important; }
    html.embed .hall-layout { gap: 0 !important; }
    html.embed .hall-scroll { padding: 8px !important; }
    html.embed .hall-inner { width: max(1200px, 100%) !important; }
  </style>
</head>

<body>
  <div id="site-header"></div>

  <main class="main">
    <div class="container">
      <h1>Схема залу — каса</h1>

      <div class="cash-badge">
        <span class="pill dark">Режим: <b>каса</b></span>
        <span class="pill" id="netPill">—</span>
        <span class="pill" id="syncPill">SYNC: —</span>
        <span class="pill" id="qPill">Черга: 0</span>
        <span class="pill" id="onlineBlockPill">tickets: —</span>
        <button id="btnSettings" class="btn btn-ghost" style="padding:8px 10px;border-radius:999px;">⚙ Налаштування</button>
      </div>

      <div class="hall-layout">
        <div class="hall-left">
          <div class="hall-scroll">
            <div class="hall-inner">

              <section class="hall-section">
                <div class="hall-section-title">Партер</div>

                <div class="parter-wrap">
                  <!-- IMPORTANT: Ложа А зліва -->
                  <div class="hall-lodge">
                    <div class="hall-lodge-label">Ложа А</div>
                    <div class="hall-lodge-seats" id="lodge-a-seats"></div>
                  </div>

                  <div id="parter-block"></div>

                  <!-- Ложа Б справа -->
                  <div class="hall-lodge">
                    <div class="hall-lodge-label">Ложа Б</div>
                    <div class="hall-lodge-seats" id="lodge-b-seats"></div>
                  </div>
                </div>
              </section>

              <section class="hall-section">
                <div class="hall-section-title">Амфітеатр</div>
                <div id="amphi-block"></div>
              </section>

              <section class="hall-section">
                <div class="hall-section-title">Балкон</div>
                <div id="balcony-block"></div>
              </section>

            </div>
          </div>

          <div class="row-price-list">
            <div class="row-price"><span>Партер, ряди 1–6</span><span class="dots"></span><b>200 грн</b></div>
            <div class="row-price"><span>Партер, ряди 7–12</span><span class="dots"></span><b>160 грн</b></div>
            <div class="row-price"><span>Партер, ряди 13–18</span><span class="dots"></span><b>140 грн</b></div>
            <div class="row-price"><span>Амфітеатр (усі ряди)</span><span class="dots"></span><b>120 грн</b></div>
            <div class="row-price"><span>Балкон, ряди 1–5</span><span class="dots"></span><b>100 грн</b></div>
            <div class="row-price"><span>Балкон, ряд 6</span><span class="dots"></span><b>80 грн</b></div>
            <div class="row-price"><span>Ложі А і Б</span><span class="dots"></span><b>10 грн</b></div>
          </div>
        </div>

        <aside class="hall-sidebar">
          <div class="card hall-card">
            <h2 class="hall-summary-title">Кошик (каса)</h2>

            <p id="summary-show" class="hall-summary-meta">Вистава: —</p>
            <p id="summary-seance" class="hall-summary-meta">Seance: —</p>
            <p id="summary-places" class="hall-summary-meta">Обрані місця: немає</p>
            <p id="summary-amount" class="hall-summary-meta">Сума: 0 грн</p>

            <div class="cash-actions">
              <button id="btn-sell" class="btn btn-sell" disabled>ПРОДАТИ (КАСА) + ДРУК</button>
              <button id="btn-reserve" class="btn btn-reserve" disabled>ДО РЕЗЕРВУ</button>
              <button id="btn-clear" class="btn btn-clear">ОЧИСТИТИ</button>
              <button id="btn-sync" class="btn btn-sync">SYNC (відправити чергу)</button>
              <button id="btn-reprint" class="btn btn-ghost" disabled>Повторити друк останньої продажі</button>
              <button id="btn-reset" class="btn btn-reset">Скинути локальні зміни для цього сеансу</button>
            </div>

            <div class="k-sep"></div>

            <div class="k-h3">Журнал каси (локально)</div>
            <div class="k-mini">Зберігається на цьому ПК (localStorage). Для офіційного реєстру продажів істина — Supabase (tickets).</div>

            <div style="display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 8px;">
              <button id="btnExportCashCsv" class="btn btn-ghost" style="padding:8px 10px;">Експорт CSV</button>
              <button id="btnClearCashLog" class="btn btn-ghost" style="padding:8px 10px;">Очистити журнал</button>
            </div>

            <div style="max-height:220px;overflow:auto;border:1px solid #e5e7eb;border-radius:12px;">
              <table class="k-table" id="cashLogTable">
                <thead>
                  <tr>
                    <th>Час</th>
                    <th>Дія</th>
                    <th>Місця</th>
                    <th>Сума</th>
                  </tr>
                </thead>
                <tbody id="cashLogBody">
                  <tr><td class="muted" colspan="4">Поки що порожньо.</td></tr>
                </tbody>
              </table>
            </div>

            <div class="note">
              <b>Офлайн:</b> “Продати” друкує квиток з QR (order/show/seat) і кладе операцію в чергу.
              <br><b>Онлайн:</b> коли є інternet — натисніть <b>SYNC</b> (або він спрацює автоматично при появі звʼязку).
              <br><b>Контроль:</b> сканер 100% прийме квиток після SYNC (бо тоді він зʼявиться в tickets).
            </div>

            <div class="smallline">
              Касир: <span class="pill" id="cashierIdPill">—</span>
              • Останній SYNC: <span class="pill" id="lastSyncPill">—</span>
            </div>
          </div>
        </aside>
      </div>
    </div>
  </main>

  <div id="site-footer"></div>
  <script type="module" src="../scripts/include.js"></script>

  <!-- Modal -->
  <div class="modalBack" id="modalBack">
    <div class="modal">
      <h2>Налаштування каси (цей ПК)</h2>

      <div class="formRow">
        <label for="inpCashierId">cashier_id (наприклад: kassa-1)</label>
        <input id="inpCashierId" placeholder="kassa-1" />
      </div>

      <div class="formRow">
        <label for="inpSecret">CASHIER_SYNC_SECRET (якщо використовується)</label>
        <input id="inpSecret" placeholder="(можна лишити пустим)" />
      </div>

      <div class="k-mini">
        Якщо секрет пустий — запит піде без заголовка <code>x-cashier-secret</code>.
      </div>

      <div class="modalActions">
        <button id="btnModalClose" class="btn btn-ghost" style="padding:10px 12px;">Закрити</button>
        <button id="btnModalSave" class="btn btn-sync" style="padding:10px 12px;">Зберегти</button>
      </div>
    </div>
  </div>

  <script>
    const qs = new URLSearchParams(location.search);
    const showSlug = (qs.get("show") || "").trim();

    // embed mode (backoffice): ?embed=1
    const EMBED = qs.get("embed") === "1";
    if (EMBED) document.documentElement.classList.add("embed");

    // Supabase project (читання проданих місць)
    const SUPABASE_URL = "https://fhusjlkneckbvnrdhbil.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_nCCfptJOb8Lzy1uAwGBJzA_OJtDneTS";

    // Edge Function cash-sync-ts (ВАЖНО!)
    const PROJECT_REF = "fhusjlkneckbvnrdhbil";
    const CASH_SYNC_V1 = `https://${PROJECT_REF}.functions.supabase.co/functions/v1/cash-sync-ts`;

    // ---- схема (как раньше) ----
   const parterRows = Array.from({ length: 18 }, (_, i) => {
  const row = i + 1;

  let price = 0;
  let className = "";

  if (row === 1)           { price = 170; className = "seat--170"; }
  else if (row <= 3)       { price = 200; className = "seat--200"; }
  else if (row <= 6)       { price = 180; className = "seat--180"; }
  else if (row <= 8)       { price = 170; className = "seat--170"; }
  else if (row <= 10)      { price = 160; className = "seat--160"; }
  else if (row <= 12)      { price = 140; className = "seat--140"; }
  else if (row <= 14)      { price = 120; className = "seat--120"; }
  else if (row <= 16)      { price = 100; className = "seat--100"; }
  else                     { price = 70;  className = "seat--70"; }

  return {
    row,
    seats: 20,
    zone: "Партер",
    price,
    className
  };
});


    const amphiLeftRows  = [
      {row:19,seats:11},{row:20,seats:11},{row:21,seats:11},{row:22,seats:11},{row:23,seats:11},
    ].map(r=>({...r, zone:"Амфітеатр (ліва)", price:0, className:"seat--amphi"}));

    const amphiRightRows = [
      {row:19,seats:11},{row:20,seats:11},{row:21,seats:11},
    ].map(r=>({...r, zone:"Амфітеатр (права)", price:0, className:"seat--amphi"}));

    const balconyRows15 = [1,2,3,4,5].map(n=>( { row:n, zone:"Балкон", price:0, className:"seat--balcony" } ));
    const balconyRow6 = { row:6, zone:"Балкон", price:0, className:"seat--balcony" };

    const lodgeSeats = Array.from({ length: 18 }, (_, i) => {
  const row = i + 1;
  let price = row <= 2 ? 170 :
              row <= 4 ? 200 :
              row <= 8 ? 180 :
              row <= 12 ? 140 :
              row <= 15 ? 120 : 100;

  return {
    index: row,
    price,
    zone: "Ложа",
    className: `seat--${price}`
  };
});

    function seatKey(meta){
      const row = meta.row ?? 0;
      const seat = meta.seat ?? 0;
      if (meta.zone === "Партер") return `P${row}-M${seat}`;
      if (String(meta.zone).startsWith("Амфітеатр")) return `A${row}-M${seat}`;
      if (meta.zone === "Балкон") return `B${row}-M${seat}`;
      if (meta.zone === "Ложа А") return `A0-M${seat}`;
      if (meta.zone === "Ложа Б") return `B0-M${seat}`;
      return `P${row}-M${seat}`;
    }

    function seatKeyToHuman(k){
      const m = String(k).match(/^([PAB])(\d+)-M(\d+)$/i);
      if (!m) return k;
      const prefix = m[1].toUpperCase();
      const row = Number(m[2]);
      const seat = Number(m[3]);
      if (prefix === "P") return `Ряд ${row}, місце ${seat} (Партер)`;
      if (prefix === "A") return row === 0 ? `Ложа А, місце ${seat}` : `Ряд ${row}, місце ${seat} (Амфітеатр)`;
      if (prefix === "B") return row === 0 ? `Ложа Б, місце ${seat}` : `Ряд ${row}, місце ${seat} (Балкон)`;
      return k;
    }

    async function fetchJsonSafe(url){
      try{
        const res = await fetch(url, {cache:"no-store"});
        if(!res.ok) return null;
        const txt = await res.text();
        try{ return JSON.parse(txt); }catch(e){ return null; }
      }catch(e){ return null; }
    }

    // --------- “оболочка кассы”: настройки + индикаторы + журнал ---------
    function fmtTime(ts){
      if(!ts) return "—";
      const d = new Date(ts);
      const pad = (n)=>String(n).padStart(2,"0");
      return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }

    function setNetPill(){
      const el = document.getElementById("netPill");
      if(!el) return;
      const on = navigator.onLine;
      el.className = "pill " + (on ? "ok" : "bad");
      el.textContent = on ? "Online" : "Offline";
    }

    function setSyncPill(text, kind){
      const el = document.getElementById("syncPill");
      if(!el) return;
      el.className = "pill " + (kind || "");
      el.textContent = text;
    }

    function setQp(n){
      const el = document.getElementById("qPill");
      if(el) el.textContent = `Черга: ${n}`;
    }

    function setTicketsPill(text, kind){
      const el = document.getElementById("onlineBlockPill");
      if(!el) return;
      el.className = "pill " + (kind || "");
      el.textContent = text;
    }

    function getCashierId(){
      return localStorage.getItem("cashier_id") || "kassa-1";
    }
    function setCashierId(v){
      localStorage.setItem("cashier_id", v || "kassa-1");
      const el = document.getElementById("cashierIdPill");
      if(el) el.textContent = getCashierId();
    }
    function getCashierSecret(){
      return localStorage.getItem("cashier_sync_secret") || "";
    }
    function setCashierSecret(v){
      localStorage.setItem("cashier_sync_secret", v || "");
    }

    function lastSyncKey(){
      return `cash_last_sync_${PROJECT_REF}`;
    }
    function setLastSync(ts){
      localStorage.setItem(lastSyncKey(), String(ts||Date.now()));
      const el = document.getElementById("lastSyncPill");
      if(el) el.textContent = fmtTime(Number(localStorage.getItem(lastSyncKey())||0));
    }
    function initLastSync(){
      const v = Number(localStorage.getItem(lastSyncKey())||0);
      const el = document.getElementById("lastSyncPill");
      if(el) el.textContent = v ? fmtTime(v) : "—";
    }

    // Cash log (локально, по seance)
    function cashLogKey(){
      return `cash_log_${SEANCE_ID || showSlug || "unknown"}`;
    }
    function loadCashLog(){
      try{
        const raw = localStorage.getItem(cashLogKey());
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      }catch(e){ return []; }
    }
    function saveCashLog(arr){
      localStorage.setItem(cashLogKey(), JSON.stringify(Array.isArray(arr)?arr:[]));
      renderCashLog();
    }
    function pushCashLog(entry){
      const arr = loadCashLog();
      arr.unshift(entry);
      if(arr.length > 300) arr.length = 300;
      saveCashLog(arr);
    }
    function renderCashLog(){
      const body = document.getElementById("cashLogBody");
      if(!body) return;

      const arr = loadCashLog();
      if(!arr.length){
        body.innerHTML = `<tr><td class="muted" colspan="4">Поки що порожньо.</td></tr>`;
        const rp = document.getElementById("btn-reprint");
        if(rp) rp.disabled = true;
        return;
      }
      body.innerHTML = arr.slice(0,60).map(x=>{
        const seats = Array.isArray(x.seats) ? x.seats.map(seatKeyToHuman).join("; ") : "";
        const sum = x.total || 0;
        return `
          <tr>
            <td class="muted">${fmtTime(x.ts)}</td>
            <td><b>${x.type}</b></td>
            <td>${seats}</td>
            <td><b>${sum} грн</b></td>
          </tr>
        `;
      }).join("");

      const last = arr[0];
      const rp = document.getElementById("btn-reprint");
      if(rp) rp.disabled = !(last && last.type==="SALE" && Array.isArray(last.tickets) && last.tickets.length);
    }

    function downloadText(filename, text){
      const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 250);
    }

    function toCsv(rows){
      const esc = (v)=>('"'+String(v??"").replace(/"/g,'""')+'"');
      return rows.map(r=>r.map(esc).join(",")).join("\n");
    }

    // ---- show meta / seance_id ----
    let SHOW_META = null;
    let SEANCE_ID = "";
    async function loadShowMeta(){
      if (!showSlug) return;
      const list = await fetchJsonSafe("../data/afisha.json");
      if (Array.isArray(list)) SHOW_META = list.find(x => x && x.id === showSlug) || null;

      const title = SHOW_META?.title || showSlug || "—";
      const date = SHOW_META?.date || "";
      const time = SHOW_META?.time || "";
      const dt = (date && time) ? ` • ${date} ${time}` : "";

      const t2 = String(time || "").replace(":", "-");
      SEANCE_ID = (showSlug && date && t2) ? `${showSlug}-${date}-${t2}` : "";

      const elShow = document.getElementById("summary-show");
      const elSeance = document.getElementById("summary-seance");
      if(elShow) elShow.textContent = `Вистава: ${title}${dt}`;
      if(elSeance) elSeance.textContent = `Seance: ${SEANCE_ID || "—"}`;

      renderCashLog();
    }

    // Онлайн-проданные места из tickets (блокируем их)
    const takenSeatsOnline = new Set();
    async function loadTakenSeatsOnline(){
      setTicketsPill("tickets: читання…", "warn");
      if (!showSlug) { setTicketsPill("tickets: —", ""); return; }

      const url = `${SUPABASE_URL}/rest/v1/tickets?show_slug=eq.${encodeURIComponent(showSlug)}&select=seat_label`;
      try{
        const res = await fetch(url, {
          headers: { apikey: SUPABASE_ANON_KEY, Authorization: `Bearer ${SUPABASE_ANON_KEY}` }
        });
        if (!res.ok) { setTicketsPill("tickets: помилка", "bad"); return; }
        const rows = await res.json().catch(()=>[]);
        takenSeatsOnline.clear();
        rows.forEach(r => { if (r && r.seat_label) takenSeatsOnline.add(String(r.seat_label)); });
        setTicketsPill(`tickets: ok (${takenSeatsOnline.size})`, "ok");
      }catch(e){
        setTicketsPill("tickets: нема інтернету", "bad");
      }
    }

    // Локальные состояния кассы по seance_id
    function cashPatchKey(){
      return `cash_patch_${SEANCE_ID || showSlug || "unknown"}`;
    }
    function loadCashPatch(){
      try{
        const raw = localStorage.getItem(cashPatchKey());
        const obj = raw ? JSON.parse(raw) : {};
        return (obj && typeof obj === "object") ? obj : {};
      }catch(e){ return {}; }
    }
    function saveCashPatch(patch){
      localStorage.setItem(cashPatchKey(), JSON.stringify(patch || {}));
    }

    // Очередь операций
    function opsQueueKey(){
      return `cash_ops_queue_v1_${PROJECT_REF}`;
    }
    function loadQueue(){
      try{
        const raw = localStorage.getItem(opsQueueKey());
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      }catch(e){ return []; }
    }
    function saveQueue(arr){
      localStorage.setItem(opsQueueKey(), JSON.stringify(Array.isArray(arr) ? arr : []));
      const n = (arr || []).length;
      setQp(n);
    }
    function refreshQueueCount(){
      const q = loadQueue();
      setQp(q.length);
    }

    let CASH_PATCH = {};
    const selected = new Map(); // key -> {price}
    const seatButtons = new Map(); // key -> button

    function getEffectiveStatus(key){
      if (takenSeatsOnline.has(key)) return "blocked";
      return CASH_PATCH[key]?.status || "free";
    }

    function applyStatusClass(btn, status){
      btn.classList.remove("seat--sold","seat--reserved","seat--blocked");
      btn.disabled = false;
      if (status === "sold"){ btn.classList.add("seat--sold"); btn.disabled = true; }
      if (status === "reserved"){ btn.classList.add("seat--reserved"); }
      if (status === "blocked"){ btn.classList.add("seat--blocked"); btn.disabled = true; }
    }

    function makeSeatElement(key,label,extraClass,price){
      const btn = document.createElement("button");
      btn.type = "button";
      btn.textContent = label;
      btn.className = "seat" + (extraClass ? " " + extraClass : "");
      btn.dataset.key = key;
      btn.dataset.price = String(price);

      applyStatusClass(btn, getEffectiveStatus(key));

      btn.addEventListener("click", ()=>{
        const st = getEffectiveStatus(key);
        if (st === "sold" || st === "blocked") return;

        if (btn.classList.contains("seat--selected")){
          btn.classList.remove("seat--selected");
          selected.delete(key);
        } else {
          btn.classList.add("seat--selected");
          selected.set(key, { price });
        }
        updateSummary();
      });

      seatButtons.set(key, btn);
      return btn;
    }

    function clearSelection(){
      for (const k of selected.keys()){
        const b = seatButtons.get(k);
        if (b) b.classList.remove("seat--selected");
      }
      selected.clear();
      updateSummary();
    }

    function reapplyAllStatuses(){
      for (const [k, b] of seatButtons.entries()){
        applyStatusClass(b, getEffectiveStatus(k));
      }
    }

    function updateSummary(){
      const placesEl = document.getElementById("summary-places");
      const amountEl = document.getElementById("summary-amount");
      const btnSell = document.getElementById("btn-sell");
      const btnRes  = document.getElementById("btn-reserve");

      const keys = Array.from(selected.keys());
      if (!keys.length){
        if(placesEl) placesEl.textContent = "Обрані місця: немає";
        if(amountEl) amountEl.textContent = "Сума: 0 грн";
        if(btnSell) btnSell.disabled = true;
        if(btnRes)  btnRes.disabled  = true;
        return;
      }

      const total = Array.from(selected.values()).reduce((s,x)=>s+(x.price||0),0);
      if(placesEl) placesEl.textContent = "Обрані місця: " + keys.map(seatKeyToHuman).join("; ");
      if(amountEl) amountEl.textContent = "Сума: " + total + " грн";
      if(btnSell) btnSell.disabled = false;
      if(btnRes)  btnRes.disabled  = false;
            // === SEND BASKET TO BACKOFFICE ===
      if (window.parent && EMBED) {
        window.parent.postMessage(
          {
            source: "hall-cash",
            type: "basket:update",
            payload: {
              seats: Array.from(selected.keys()),
              total
            }
          },
          "*"
        );
      }

    }

    function applyStatusToSelectedLocal(status){
      const keys = Array.from(selected.keys());
      if (!keys.length) return;

      for (const k of keys){
        if (takenSeatsOnline.has(k)) continue;
        CASH_PATCH[k] = { status, ts: Date.now() };
      }
      saveCashPatch(CASH_PATCH);

      pushCashLog({
        ts: Date.now(),
        type: status === "reserved" ? "RESERVE" : String(status||"").toUpperCase(),
        seats: keys,
        total: Array.from(selected.values()).reduce((s,x)=>s+(x.price||0),0)
      });

      clearSelection();
      reapplyAllStatuses();
    }

    // ---- op_id generator ----
    function genOpId(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      const hh = String(d.getHours()).padStart(2,"0");
      const mi = String(d.getMinutes()).padStart(2,"0");
      const ss = String(d.getSeconds()).padStart(2,"0");
      const rnd = Math.random().toString(16).slice(2,8);
      return `KR-SHEV-${yyyy}${mm}${dd}-${hh}${mi}${ss}-${rnd}`;
    }

    // order_id как на сервере (cash-sync-ts)
    function calcCashOrderId(seance_id, show_slug, op_id){
      const base = seance_id ? seance_id : show_slug;
      return `CASH-${base}-${op_id}`;
    }

    // ---- печать билетов (с QR) ----
    async function openPrintWindowOffline(tickets, meta){
      const theatre = "Театр ім. Т. Г. Шевченка";
      const title = meta?.title || showSlug || "Квиток";
      const dt = (meta?.date && meta?.time) ? `${meta.date} ${meta.time}` : "";
      const seance = SEANCE_ID || "";

      const cardsHtml = [];
      for (const t of tickets){
        const payload = `order:${t.order_id}|show:${t.show_slug}|seat:${t.seat_label}`;

        let qrDataUrl = "";
        try{
          qrDataUrl = await window.QRCode.toDataURL(payload, { width: 320, margin: 2, errorCorrectionLevel: "M" });

        }catch(e){ qrDataUrl = ""; }

        cardsHtml.push(`
          <div class="t">
            <div class="h">
              <div class="theatre">${theatre}</div>
              <div class="ord">Канал: Каса<br/>OP: ${t.op_id}</div>
            </div>
            <div class="show">${title}</div>
            <div class="meta">
              ${dt ? `<div>Дата/час: ${dt}</div>` : ``}
              <div><b>${seatKeyToHuman(t.seat_label)}</b></div>
              ${seance ? `<div class="muted">Seance: ${seance}</div>` : ``}
              <div class="muted">Order: ${t.order_id}</div>
            </div>
            <div class="price">Ціна: ${t.price} грн</div>

            ${qrDataUrl ? `<img class="qr" src="${qrDataUrl}" alt="QR"/>` : `<div class="qr-miss">QR не згенеровано</div>`}

            <div class="note">
              Квиток дійсний на одну особу. Зберігайте до кінця вистави.<br/>
              Для гарантованого сканування натисніть SYNC (коли є інтернет).
            </div>
          </div>
        `);
      }

      const html = `<!doctype html>
<html lang="uk">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Друк квитків</title>
<style>
  body{font-family:Arial,sans-serif;margin:16px;color:#111827;}
  .wrap{display:flex;flex-wrap:wrap;gap:14px;}
  .t{width:320px;border:1px solid #e5e7eb;border-radius:14px;padding:12px;}
  .h{display:flex;justify-content:space-between;gap:10px;margin-bottom:6px;}
  .theatre{font-weight:700;font-size:12px;}
  .ord{font-size:11px;color:#6b7280;text-align:right;}
  .show{font-size:14px;font-weight:800;margin:6px 0 4px;}
  .meta{font-size:12px;color:#374151;line-height:1.35;}
  .muted{font-size:11px;color:#6b7280;margin-top:4px;}
  .price{margin-top:8px;font-size:14px;font-weight:800;}
  .qr{display:block;margin:10px auto 6px;width:190px;height:190px;border:1px solid #e5e7eb;border-radius:10px;}
  .qr-miss{margin:10px 0;padding:10px;border:1px dashed #e5e7eb;border-radius:10px;color:#6b7280;text-align:center;}
  .note{font-size:10px;color:#6b7280;line-height:1.3;margin-top:8px;}
</style>
</head>
<body>
  <div class="wrap">${cardsHtml.join("")}</div>
</body>
</html>`;

      const w = window.open("", "_blank");
      if (!w){ alert("Браузер заблокував pop-up. Дозволь відкриття вікон для друку."); return; }
      w.document.open();
      w.document.write(html);
      w.document.close();

      setTimeout(()=>{ try{ w.focus(); w.print(); }catch(e){} }, 250);
    }

    async function postCashSync(cashier_id, ops){
      const secret = getCashierSecret().trim();
      const headers = { "Content-Type": "application/json" };
      if (secret) headers["x-cashier-secret"] = secret;

      const res = await fetch(CASH_SYNC_V1, {
        method:"POST",
        headers,
        body: JSON.stringify({ cashier_id, ops }),
      });

      const txt = await res.text();
      let data = null;
      try{ data = JSON.parse(txt); }catch(e){ data = { raw: txt }; }
      return { ok: res.ok, status: res.status, data };
    }

    async function syncQueue(){
      const queue = loadQueue();
      if (!queue.length) { alert("Черга порожня."); return; }

      const cashier_id = getCashierId();
      setSyncPill("SYNC: відправка…", "warn");

      const r = await postCashSync(cashier_id, queue);

      if (!r.ok){
        const msg = (r.data && (r.data.details || r.data.error)) ? (r.data.details || r.data.error) : "unknown";
        setSyncPill("SYNC: помилка", "bad");
        alert("SYNC помилка: " + msg);
        return;
      }

      const resArr = Array.isArray(r.data?.results) ? r.data.results : [];
      const okOps = new Set(resArr.filter(x => x && x.ok === true).map(x => x.op_id));

      const left = queue.filter(op => !okOps.has(op.op_id));
      saveQueue(left);

      setLastSync(Date.now());
      setSyncPill(`SYNC: ok=${okOps.size}, left=${left.length}`, okOps.size ? "ok" : "");

      const bad = resArr.filter(x=>x && x.ok !== true);
      if (bad.length){
        const msg = bad.slice(0,6).map(x=>`${x.op_id}: ${(x.error||x.details||"error")}`).join("\n");
        alert("SYNC частково з помилками:\n" + msg);
      }

      await loadTakenSeatsOnline();
      reapplyAllStatuses();
    }

    // ---- ПРОДАЖА (офлайн) ----
    async function sellAndPrintOffline(){
      const keys = Array.from(selected.keys());
      if (!keys.length) return;

      if (!SEANCE_ID){
        alert("Немає seance_id (потрібні date/time в afisha.json).");
        return;
      }

      const op_id = genOpId();

      const prices = {};
      for (const k of keys) prices[k] = Number(selected.get(k)?.price || 0);

      const op = {
        op_id,
        type: "sale",
        seance_id: SEANCE_ID,
        show_slug: showSlug,
        seats: keys,
        prices,
        sold_at: new Date().toISOString(),
      };

      const queue = loadQueue();
      queue.push(op);
      saveQueue(queue);

      for (const k of keys){
        if (takenSeatsOnline.has(k)) continue;
        CASH_PATCH[k] = { status: "sold", ts: Date.now(), op_id };
      }
      saveCashPatch(CASH_PATCH);

      const order_id = calcCashOrderId(SEANCE_ID, showSlug, op_id);
      const tickets = keys.map(k => ({
        op_id,
        order_id,
        show_slug: showSlug,
        seat_label: k,
        price: Number(prices[k] || 0),
      }));

      pushCashLog({
        ts: Date.now(),
        type: "SALE",
        seats: keys,
        total: tickets.reduce((s,t)=>s+(t.price||0),0),
        tickets
      });

      clearSelection();
      reapplyAllStatuses();
      await openPrintWindowOffline(tickets, SHOW_META);

      try{
        if (navigator.onLine) {
          const q2 = loadQueue();
          if (q2.length) await syncQueue();
        }
      }catch(e){}
    }

    // ---- reprint last sale ----
    async function reprintLastSale(){
      const arr = loadCashLog();
      const last = arr.find(x=>x && x.type==="SALE" && Array.isArray(x.tickets) && x.tickets.length) || null;
      if (!last){ alert("Немає збереженої останньої продажі для друку."); return; }
      await openPrintWindowOffline(last.tickets, SHOW_META);
    }

    // ---- render blocks ----
    function renderParter(){
      const block = document.getElementById("parter-block");
      block.innerHTML = "";
      parterRows.forEach(r=>{
        const rowLine = document.createElement("div");
        rowLine.className = "row-line";

        const lab = document.createElement("div");
        lab.className = "row-label";
        lab.textContent = r.row;
        rowLine.appendChild(lab);

        const seatsRow = document.createElement("div");
        seatsRow.className = "seats-row";

        for (let s=1; s<=r.seats; s++){
          const key = seatKey({zone:"Партер", row:r.row, seat:s});
          const cls = r.className + (s===10 ? " seat--gap-right" : "");
          seatsRow.appendChild(makeSeatElement(key, s, cls, r.price));
        }

        rowLine.appendChild(seatsRow);
        block.appendChild(rowLine);
      });
    }

    function renderLodges(){
      const a = document.getElementById("lodge-a-seats");
      const b = document.getElementById("lodge-b-seats");
      a.innerHTML = ""; b.innerHTML = "";

      lodgeSeats.forEach(ls=>{
        const keyA = seatKey({zone:"Ложа А", row:0, seat:ls.index});
        const keyB = seatKey({zone:"Ложа Б", row:0, seat:ls.index});
        a.appendChild(makeSeatElement(keyA, ls.index, ls.className, 10));
        b.appendChild(makeSeatElement(keyB, ls.index, ls.className, 10));
      });
    }

    function renderAmphi(){
      const block = document.getElementById("amphi-block");
      block.innerHTML = "";
      [19,20,21,22,23].forEach(rowNum=>{
        const rowLine = document.createElement("div");
        rowLine.className = "row-line";

        const lab = document.createElement("div");
        lab.className = "row-label";
        lab.textContent = rowNum;
        rowLine.appendChild(lab);

        const left = document.createElement("div");
        left.className = "seats-row";
        const right = document.createElement("div");
        right.className = "seats-row";
        const gap = document.createElement("div");
        gap.className = "amphi-gap";

        const leftCfg = amphiLeftRows.find(r=>r.row===rowNum);
        const rightCfg = amphiRightRows.find(r=>r.row===rowNum);

        if (leftCfg){
          for(let s=1;s<=leftCfg.seats;s++){
            const key = seatKey({zone:leftCfg.zone, row:rowNum, seat:s});
            left.appendChild(makeSeatElement(key, s, leftCfg.className, 120));
          }
        }
        if (rightCfg){
          for(let s=1;s<=rightCfg.seats;s++){
            const seatNum = s+11;
            const key = seatKey({zone:rightCfg.zone, row:rowNum, seat:seatNum});
            right.appendChild(makeSeatElement(key, seatNum, rightCfg.className, 120));
          }
        }

        rowLine.appendChild(left);
        rowLine.appendChild(gap);
        rowLine.appendChild(right);
        block.appendChild(rowLine);
      });
    }

    function renderBalcony(){
      const block = document.getElementById("balcony-block");
      block.innerHTML = "";

      balconyRows15.forEach(r=>{
        const rowLine = document.createElement("div");
        rowLine.className = "row-line";

        const lab = document.createElement("div");
        lab.className = "row-label";
        lab.textContent = r.row;
        rowLine.appendChild(lab);

        const seatsRow = document.createElement("div");
        seatsRow.className = "seats-row";

        for(let pos=1;pos<=28;pos++){
          const key = seatKey({zone:"Балкон", row:r.row, seat:pos});
          const cls = r.className + (pos===14 ? " seat--gap-right" : "");
          seatsRow.appendChild(makeSeatElement(key, pos, cls, 100));
        }

        rowLine.appendChild(seatsRow);
        block.appendChild(rowLine);
      });

      const rowLine = document.createElement("div");
      rowLine.className = "row-line";

      const lab = document.createElement("div");
      lab.className = "row-label";
      lab.textContent = 6;
      rowLine.appendChild(lab);

      const seatsRow = document.createElement("div");
      seatsRow.className = "seats-row";

      for(let pos=1;pos<=28;pos++){
        if (pos<=10){
          const key = seatKey({zone:"Балкон", row:6, seat:pos});
          const cls = "seat--balcony" + (pos===10 ? " seat--gap-right" : "");
          seatsRow.appendChild(makeSeatElement(key, pos, cls, 80));
        } else if (pos>=19){
          const seatNum = pos-8;
          const key = seatKey({zone:"Балкон", row:6, seat:seatNum});
          seatsRow.appendChild(makeSeatElement(key, seatNum, "seat--balcony", 80));
        } else {
          const empty = document.createElement("button");
          empty.type="button";
          empty.className="seat seat--empty";
          seatsRow.appendChild(empty);
        }
      }

      rowLine.appendChild(seatsRow);
      block.appendChild(rowLine);
    }

    // ---- кнопки ----
    document.getElementById("btn-clear")?.addEventListener("click", ()=> clearSelection());
    document.getElementById("btn-reserve")?.addEventListener("click", ()=> applyStatusToSelectedLocal("reserved"));
    document.getElementById("btn-sell")?.addEventListener("click", ()=> sellAndPrintOffline());
    document.getElementById("btn-sync")?.addEventListener("click", ()=> syncQueue());
    document.getElementById("btn-reprint")?.addEventListener("click", ()=> reprintLastSale());

    document.getElementById("btn-reset")?.addEventListener("click", ()=>{
      if (!confirm("Скинути всі локальні касові стани для цього сеансу на цьому ПК?")) return;
      CASH_PATCH = {};
      saveCashPatch(CASH_PATCH);
      clearSelection();
      reapplyAllStatuses();
      alert("Локальні зміни скинуто.");
    });

    // export cash log CSV
    document.getElementById("btnExportCashCsv")?.addEventListener("click", ()=>{
      const arr = loadCashLog();
      const rows = [["time","type","seats","total"]];
      for(const x of arr){
        const seats = Array.isArray(x.seats) ? x.seats.join(";") : "";
        rows.push([new Date(x.ts||0).toISOString(), x.type||"", seats, String(x.total||0)]);
      }
      const name = `cash_log_${showSlug || "show"}_${(SEANCE_ID||"").replaceAll(":","-")}.csv`;
      downloadText(name, toCsv(rows));
    });

    document.getElementById("btnClearCashLog")?.addEventListener("click", ()=>{
      if(!confirm("Очистити локальний журнал каси для цього сеансу?")) return;
      saveCashLog([]);
    });

    // auto sync when online comes back
    window.addEventListener("online", async ()=>{
      setNetPill();
      try{
        const q = loadQueue();
        if (q.length) await syncQueue();
      }catch(e){}
    });
    window.addEventListener("offline", ()=> setNetPill());

    // Settings modal
    const modalBack = document.getElementById("modalBack");
    function openModal(){
      document.getElementById("inpCashierId").value = getCashierId();
      document.getElementById("inpSecret").value = getCashierSecret();
      modalBack.style.display = "flex";
    }
    function closeModal(){ modalBack.style.display = "none"; }
    document.getElementById("btnSettings")?.addEventListener("click", openModal);
    document.getElementById("btnModalClose")?.addEventListener("click", closeModal);
    document.getElementById("btnModalSave")?.addEventListener("click", ()=>{
      const id = (document.getElementById("inpCashierId").value || "").trim() || "kassa-1";
      const sec = (document.getElementById("inpSecret").value || "").trim();
      setCashierId(id);
      setCashierSecret(sec);
      closeModal();
      alert("Збережено.");
    });
    modalBack?.addEventListener("click",(e)=>{ if(e.target===modalBack) closeModal(); });

    // -------------------- Backoffice iframe control via postMessage --------------------
    function isTrustedMessage(ev){
      // GitHub Pages: origin будет https://monks-commits.github.io
      // Но на всякий: разрешаем тот же origin, что и у страницы
      return !!ev && ev.origin === window.location.origin;
    }

    function applyStatusFromBackoffice(status, seats){
      const keys = Array.isArray(seats) ? seats : [];
      if(!keys.length) return;

      // снимаем текущий выбор
      clearSelection();

      // локально применяем как будто кассир нажал кнопку
      if(status === "reserved"){
        // резерв (локально)
        for(const k of keys){
          if (takenSeatsOnline.has(k)) continue;
          CASH_PATCH[k] = { status: "reserved", ts: Date.now() };
        }
        saveCashPatch(CASH_PATCH);
        pushCashLog({
          ts: Date.now(),
          type: "RESERVE",
          seats: keys,
          total: keys.reduce((s,k)=>s + Number(seatButtons.get(k)?.dataset?.price || 0), 0)
        });
        reapplyAllStatuses();
        return;
      }

      if(status === "sold"){
        // продажа = то же, что sellAndPrintOffline(), но без кликов и с ценами из DOM
        if(!SEANCE_ID){
          alert("Немає seance_id (потрібні date/time в afisha.json).");
          return;
        }

        const op_id = genOpId();

        const prices = {};
        for (const k of keys){
          const b = seatButtons.get(k);
          prices[k] = Number(b?.dataset?.price || 0);
        }

        const op = {
          op_id,
          type: "sale",
          seance_id: SEANCE_ID,
          show_slug: showSlug,
          seats: keys,
          prices,
          sold_at: new Date().toISOString(),
        };

        const queue = loadQueue();
        queue.push(op);
        saveQueue(queue);

        for (const k of keys){
          if (takenSeatsOnline.has(k)) continue;
          CASH_PATCH[k] = { status: "sold", ts: Date.now(), op_id };
        }
        saveCashPatch(CASH_PATCH);

        const order_id = calcCashOrderId(SEANCE_ID, showSlug, op_id);
        const tickets = keys.map(k => ({
          op_id,
          order_id,
          show_slug: showSlug,
          seat_label: k,
          price: Number(prices[k] || 0),
        }));

        pushCashLog({
          ts: Date.now(),
          type: "SALE",
          seats: keys,
          total: tickets.reduce((s,t)=>s+(t.price||0),0),
          tickets
        });

        reapplyAllStatuses();
        openPrintWindowOffline(tickets, SHOW_META).catch(()=>{});

        // если онлайн — пробуем синкнуть
        setTimeout(async ()=>{
          try{
            if (navigator.onLine) {
              const q2 = loadQueue();
              if (q2.length) await syncQueue();
            }
          }catch(e){}
        }, 50);

        return;
      }

      // прочие статусы: просто применим локально
      for(const k of keys){
        if (takenSeatsOnline.has(k)) continue;
        CASH_PATCH[k] = { status: String(status||"free"), ts: Date.now() };
      }
      saveCashPatch(CASH_PATCH);
      reapplyAllStatuses();
    }

    function seatSearchFromBackoffice(key){
      const k = String(key || "").trim();
      if(!k) return;
      const btn = seatButtons.get(k);
      if(btn) btn.scrollIntoView({behavior:"smooth", block:"center", inline:"center"});
      else alert("Не знайдено місце: " + k);
    }

    window.addEventListener("message", (ev)=>{
      if(!isTrustedMessage(ev)) return;
      const msg = ev.data || {};
      if(msg.source !== "backoffice") return;

      if(msg.type === "apply_status"){
        const st = msg.payload?.status;
        const seats = msg.payload?.seats;
        applyStatusFromBackoffice(st, seats);
        return;
      }

      if(msg.type === "seat_search"){
        seatSearchFromBackoffice(msg.payload?.key);
        return;
      }

      if(msg.type === "reload"){
        location.reload();
        return;
      }
    });

    // ---- boot ----
    (async ()=>{
      setNetPill();
      initLastSync();
      setCashierId(getCashierId());

      setSyncPill("SYNC: —", "");
      refreshQueueCount();

      await loadShowMeta();
      CASH_PATCH = loadCashPatch();

      await loadTakenSeatsOnline().catch(()=>{});
      renderParter();
      renderLodges();
      renderAmphi();
      renderBalcony();
      updateSummary();
      renderCashLog();
    })();
  </script>
</body>
</html>
